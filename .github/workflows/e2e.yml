name: Agentcube E2E Tests

on:
  pull_request:
    branches:
      - main
      - "release-*"

jobs:
  e2e-test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          version: v0.30.0
          cluster_name: agentcube-e2e
          # We don't need to install it here because run_e2e.sh handles cluster creation if not exists,
          # but using the action is cleaner for setup. However, run_e2e.sh does `kind create cluster`,
          # so we should probably let the script handle it or adjust the script.
          # Looking at run_e2e.sh, it runs `kind create cluster`.
          # To avoid conflicts, let's just install kind tool but not create cluster, OR let the action create it and skip creation in script.
          # Simplest is to install kind and let script run.
          install_only: true

      - name: Run E2E Tests
        run: |
          export ARTIFACTS_PATH=${{ github.workspace }}/e2e-logs
          make e2e

      - name: Upload E2E Component Logs
        if: failure() # Only upload logs when tests fail
        uses: actions/upload-artifact@v4
        with:
          name: agentcube_e2e_logs_${{ github.run_id }}_${{ github.run_attempt }}
          path: ${{ github.workspace }}/e2e-logs/
          if-no-files-found: ignore

      - name: Clean up E2E Environment
        if: always() # Run even if tests fail
        run: make e2e-clean
